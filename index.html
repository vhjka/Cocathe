<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بث فيديو مباشر متزامن</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        header {
            margin-bottom: 30px;
            position: relative;
        }
        
        .developer-badge {
            position: absolute;
            top: -10px;
            left: -10px;
            background: linear-gradient(45deg, #d81b60, #b71c5c);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        h1 {
            color: #d81b60;
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .heart {
            color: #d81b60;
            display: inline-block;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        p {
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 10px;
        }
        
        .input-section {
            margin: 25px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        input {
            width: 100%;
            max-width: 600px;
            padding: 15px;
            border: 2px solid #ff9a9e;
            border-radius: 10px;
            font-size: 1.1rem;
            margin-bottom: 15px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #d81b60;
            box-shadow: 0 0 10px rgba(216, 27, 96, 0.3);
        }
        
        button {
            padding: 15px 30px;
            background: linear-gradient(to right, #d81b60, #b71c5c);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin: 5px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .video-container {
            margin-top: 30px;
            position: relative;
            padding-bottom: 56.25%; /* نسبة aspect 16:9 */
            height: 0;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            background: #000;
            transition: all 0.5s ease;
        }
        
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 12px 25px;
            font-size: 1rem;
        }
        
        .play-btn {
            background: linear-gradient(to right, #4caf50, #2e7d32);
        }
        
        .pause-btn {
            background: linear-gradient(to right, #f44336, #c62828);
        }
        
        .seek-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            width: 100%;
            justify-content: center;
        }
        
        .seek-input {
            padding: 10px;
            border: 2px solid #ff9a9e;
            border-radius: 8px;
            width: 80px;
            text-align: center;
        }
        
        .seek-btn {
            padding: 10px 15px;
            background: linear-gradient(to right, #2196f3, #1976d2);
        }
        
        .users-count {
            margin: 15px 0;
            font-size: 1.1rem;
            color: #d81b60;
            font-weight: bold;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: #e8f5e9;
            color: #2e7d32;
            display: none;
        }
        
        .error {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: #ffebee;
            color: #c62828;
            display: none;
        }
        
        .instructions {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: right;
        }
        
        .instructions h3 {
            color: #d81b60;
            margin-bottom: 15px;
        }
        
        .instructions ul {
            list-style-type: none;
            padding: 0;
        }
        
        .instructions li {
            margin-bottom: 10px;
            padding-right: 20px;
            position: relative;
        }
        
        .instructions li:before {
            content: "♥";
            color: #d81b60;
            position: absolute;
            right: 0;
        }
        
        .platform-badges {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .platform-badge {
            background: linear-gradient(to right, #9c27b0, #7b1fa2);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        footer {
            margin-top: 30px;
            color: #777;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            input, button {
                width: 100%;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .developer-badge {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 15px;
            }
            
            .seek-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="developer-badge">مطور التطبيق: محمد الناصر محمودي</div>
            <h1><span class="heart">❤️</span> بث فيديو مباشر متزامن <span class="heart">❤️</span></h1>
            <p>شاهدوا الفيديو معاً في نفس اللحظة مع من تحبون</p>
            <p>أي تحكم في التشغيل أو الإيقاف أو التقديم السريع سينطبق على جميع المشاهدين</p>
        </header>
        
        <div class="platform-badges">
            <span class="platform-badge">يوتيوب</span>
            <span class="platform-badge">فيسبوك</span>
            <span class="platform-badge">تيك توك</span>
            <span class="platform-badge">فيميو</span>
            <span class="platform-badge">DailyMotion</span>
            <span class="platform-badge">وغيرها</span>
        </div>
        
        <div class="input-section">
            <input type="text" id="videoUrl" placeholder="https://www.youtube.com/watch?v=..." autocomplete="off">
            <button onclick="loadVideo()">تحميل الفيديو للجميع</button>
            <div class="status" id="statusMessage">جاري تحميل الفيديو...</div>
            <div class="error" id="errorMessage"></div>
        </div>
        
        <div class="video-container" id="videoContainer">
            <!-- سيتم عرض الفيديو هنا -->
        </div>
        
        <div class="controls">
            <button class="control-btn play-btn" onclick="playVideo()">تشغيل للجميع</button>
            <button class="control-btn pause-btn" onclick="pauseVideo()">إيقاف للجميع</button>
            
            <div class="seek-controls">
                <input type="number" id="seekTime" class="seek-input" placeholder="ثانية" min="0">
                <button class="control-btn seek-btn" onclick="seekVideo()">انتقل إلى الوقت</button>
            </div>
        </div>
        
        <div class="users-count" id="usersCount">0 مستخدم متصل</div>
        
        <div class="instructions">
            <h3>كيفية استخدام الموقع:</h3>
            <ul>
                <li>أدخل رابط فيديو من أي منصة (يوتيوب، فيسبوك، تيك توك، إلخ)</li>
                <li>اضغط على زر "تحميل الفيديو للجميع"</li>
                <li>سيظهر الفيديو لجميع المتصلين في نفس الوقت</li>
                <li>أي ضغط على زر تشغيل أو إيقاف أو تقديم سريع سينطبق على الجميع</li>
                <li>شارك رابط هذه الصفحة مع من تريد لمشاهدة الفيديو معاً</li>
            </ul>
        </div>
        
        <footer>
            <p>صنع بكل ❤️ لمشاركة اللحظات الجميلة معاً في نفس اللحظة</p>
        </footer>
    </div>

    <!-- إضافة Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <script>
        // بيانات التكوين الخاصة بك من Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAuUEBZVQEaONvsQa3NVfogRPvrW30vm6Y",
            authDomain: "nasser-1c6b6.firebaseapp.com",
            databaseURL: "https://nasser-1c6b6-default-rtdb.firebaseio.com",
            projectId: "nasser-1c6b6",
            storageBucket: "nasser-1c6b6.firebasestorage.app",
            messagingSenderId: "616955555202",
            appId: "1:616955555202:web:ff097422e646cab1cb739b"
        };

        // تهيئة Firebase
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("تم تهيئة Firebase بنجاح");
        } catch (error) {
            console.error('خطأ في تهيئة Firebase:', error);
            showError('حدث خطأ في الاتصال بقاعدة البيانات. تأكد من إعدادات Firebase.');
        }
        
        let currentVideoUrl = null;
        let currentVideoType = null;
        let isHost = false;
        let connectedUsers = 0;
        let youtubePlayer = null;
        
        // دالة لتحميل الفيديو
        function loadVideo() {
            const videoUrl = document.getElementById('videoUrl').value.trim();
            const statusMessage = document.getElementById('statusMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.style.display = 'none';
            
            if (!videoUrl) {
                showError('يرجى إدخال رابط الفيديو أولاً');
                return;
            }
            
            statusMessage.style.display = 'block';
            statusMessage.textContent = 'جاري تحميل الفيديو...';
            
            try {
                // حفظ رابط الفيديو الحالي
                currentVideoUrl = videoUrl;
                
                // تحديد نوع الفيديو
                currentVideoType = getVideoType(videoUrl);
                
                // إنشاء iframe للفيديو
                createVideoEmbed(videoUrl);
                
                // حفظ حالة الفيديو في Firebase
                saveVideoStateToFirebase('load', videoUrl, currentVideoType);
                
                statusMessage.textContent = 'تم تحميل الفيديو للجميع!';
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 3000);
                
                isHost = true;
            } catch (error) {
                console.error('Error loading video:', error);
                showError('حدث خطأ في تحميل الفيديو. يرجى المحاولة مرة أخرى.');
            }
        }
        
        // دالة لتحديد نوع الفيديو
        function getVideoType(videoUrl) {
            if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
                return 'youtube';
            } else if (videoUrl.includes('vimeo.com')) {
                return 'vimeo';
            } else if (videoUrl.includes('facebook.com') || videoUrl.includes('fb.watch')) {
                return 'facebook';
            } else if (videoUrl.includes('tiktok.com')) {
                return 'tiktok';
            } else if (videoUrl.includes('dailymotion.com') || videoUrl.includes('dai.ly')) {
                return 'dailymotion';
            } else {
                return 'generic';
            }
        }
        
        // دالة لإنشاء iframe للفيديو
        function createVideoEmbed(videoUrl) {
            const videoContainer = document.getElementById('videoContainer');
            
            // إنشاء iframe للفيديو
            let embedCode = '';
            const videoType = getVideoType(videoUrl);
            
            // YouTube
            if (videoType === 'youtube') {
                let videoId = '';
                
                if (videoUrl.includes('youtube.com')) {
                    videoId = videoUrl.split('v=')[1];
                    const ampersandPosition = videoId.indexOf('&');
                    if (ampersandPosition !== -1) {
                        videoId = videoId.substring(0, ampersandPosition);
                    }
                } else if (videoUrl.includes('youtu.be')) {
                    videoId = videoUrl.split('/').pop();
                }
                
                embedCode = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            } 
            // Vimeo
            else if (videoType === 'vimeo') {
                const videoId = videoUrl.split('/').pop();
                embedCode = `<iframe src="https://player.vimeo.com/video/${videoId}" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
            } 
            // Facebook
            else if (videoType === 'facebook') {
                embedCode = `<iframe src="https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(videoUrl)}&show_text=0&width=476" frameborder="0" allowfullscreen="true"></iframe>`;
            } 
            // TikTok
            else if (videoType === 'tiktok') {
                const videoId = videoUrl.split('/').pop();
                embedCode = `<iframe src="https://www.tiktok.com/embed/v2/${videoId}" frameborder="0" allowfullscreen></iframe>`;
            } 
            // DailyMotion
            else if (videoType === 'dailymotion') {
                let videoId = '';
                
                if (videoUrl.includes('dailymotion.com')) {
                    videoId = videoUrl.split('/').pop();
                    if (videoId.includes('_')) {
                        videoId = videoId.split('_')[0];
                    }
                } else if (videoUrl.includes('dai.ly')) {
                    videoId = videoUrl.split('/').pop();
                }
                
                embedCode = `<iframe src="https://www.dailymotion.com/embed/video/${videoId}" frameborder="0" allowfullscreen></iframe>`;
            } 
            // إذا لم نتمكن من التعرف على المنصة، نستخدم iframe عام
            else {
                embedCode = `<iframe src="${videoUrl}" frameborder="0" allowfullscreen style="width: 100%; height: 100%;"></iframe>`;
            }
            
            videoContainer.innerHTML = embedCode;
            
            // إضافة event listener للفيديو بعد تحميله
            setTimeout(() => {
                const iframe = videoContainer.querySelector('iframe');
                if (iframe) {
                    iframe.onload = function() {
                        console.log('تم تحميل الفيديو بنجاح');
                    };
                }
            }, 1000);
        }
        
        // دالة لتشغيل الفيديو للجميع
        function playVideo() {
            if (currentVideoUrl) {
                // إضافة معلمة التشغيل التلقائي بناءً على نوع المنصة
                let autoplayUrl = currentVideoUrl;
                
                if (currentVideoType === 'youtube') {
                    autoplayUrl = currentVideoUrl + (currentVideoUrl.includes('?') ? '&' : '?') + 'autoplay=1';
                } else if (currentVideoType === 'vimeo') {
                    autoplayUrl = currentVideoUrl + (currentVideoUrl.includes('?') ? '&' : '?') + 'autoplay=1';
                }
                
                createVideoEmbed(autoplayUrl);
            }
            
            saveVideoStateToFirebase('play', currentVideoUrl, currentVideoType);
        }
        
        // دالة لإيقاف الفيديو للجميع
        function pauseVideo() {
            if (currentVideoUrl) {
                // إزالة معلمة التشغيل التلقائي بناءً على نوع المنصة
                let noAutoplayUrl = currentVideoUrl;
                
                if (currentVideoUrl.includes('autoplay=1')) {
                    noAutoplayUrl = currentVideoUrl.replace('autoplay=1', 'autoplay=0');
                } else if (currentVideoUrl.includes('autoplay=true')) {
                    noAutoplayUrl = currentVideoUrl.replace('autoplay=true', 'autoplay=false');
                } else {
                    noAutoplayUrl = currentVideoUrl + (currentVideoUrl.includes('?') ? '&' : '?') + 'autoplay=0';
                }
                
                createVideoEmbed(noAutoplayUrl);
            }
            
            saveVideoStateToFirebase('pause', currentVideoUrl, currentVideoType);
        }
        
        // دالة للانتقال إلى وقت محدد في الفيديو
        function seekVideo() {
            const seekTime = document.getElementById('seekTime').value;
            if (!seekTime || isNaN(seekTime)) {
                showError('يرجى إدخال وقت صحيح بالثواني');
                return;
            }
            
            // هذه الميزة تعمل فقط مع YouTube حالياً
            if (currentVideoType !== 'youtube') {
                showError('ميزة الانتقال إلى وقت محدد متاحة فقط لفيديوهات YouTube حالياً');
                return;
            }
            
            saveVideoStateToFirebase('seek', currentVideoUrl, currentVideoType, parseInt(seekTime));
        }
        
        // دالة لحفظ حالة الفيديو في Firebase
        function saveVideoStateToFirebase(action, videoUrl = null, videoType = null, seekTime = null) {
            if (!database) {
                showError('قاعدة البيانات غير متاحة. تأكد من إعدادات Firebase.');
                return;
            }
            
            const state = {
                action: action,
                videoUrl: videoUrl || currentVideoUrl,
                videoType: videoType || currentVideoType,
                seekTime: seekTime,
                timestamp: Date.now(),
                userId: Math.random().toString(36).substring(7) // معرف فريد للمستخدم
            };
            
            // حفظ في Firebase
            database.ref('videoState').set(state)
                .then(() => {
                    console.log('تم حفظ حالة الفيديو في Firebase');
                })
                .catch((error) => {
                    console.error('خطأ في حفظ حالة الفيديو:', error);
                    showError('حدث خطأ في المزامنة. يرجى المحاولة مرة أخرى.');
                });
        }
        
        // الاستماع للتغييرات في Firebase
        function listenToFirebaseChanges() {
            if (!database) {
                showError('قاعدة البيانات غير متاحة. تأكد من إعدادات Firebase.');
                return;
            }
            
            database.ref('videoState').on('value', (snapshot) => {
                const state = snapshot.val();
                if (state) {
                    handleIncomingData(state);
                }
            });
            
            // تحديث عدد المستخدمين المتصلين
            const connectedRef = database.ref('.info/connected');
            const usersRef = database.ref('connectedUsers');
            
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    const userRef = usersRef.push();
                    userRef.set(true);
                    userRef.onDisconnect().remove();
                    
                    usersRef.on('value', (snap) => {
                        connectedUsers = snap.numChildren();
                        document.getElementById('usersCount').textContent = `${connectedUsers} مستخدم متصل`;
                    });
                }
            });
        }
        
        // معالجة البيانات الواردة من Firebase
        function handleIncomingData(state) {
            // إذا كانت البيانات من نفس المستخدم، لا تقم بتنفيذها
            if (state.userId === window.userId) {
                return;
            }
            
            switch(state.action) {
                case 'load':
                    if (state.videoUrl && state.videoUrl !== currentVideoUrl) {
                        document.getElementById('videoUrl').value = state.videoUrl;
                        currentVideoUrl = state.videoUrl;
                        currentVideoType = state.videoType || getVideoType(state.videoUrl);
                        createVideoEmbed(state.videoUrl);
                    }
                    break;
                case 'play':
                    if (state.videoUrl) {
                        document.getElementById('videoUrl').value = state.videoUrl;
                        currentVideoUrl = state.videoUrl;
                        currentVideoType = state.videoType || getVideoType(state.videoUrl);
                        playVideo();
                    }
                    break;
                case 'pause':
                    if (state.videoUrl) {
                        document.getElementById('videoUrl').value = state.videoUrl;
                        currentVideoUrl = state.videoUrl;
                        currentVideoType = state.videoType || getVideoType(state.videoUrl);
                        pauseVideo();
                    }
                    break;
                case 'seek':
                    if (state.videoUrl && state.seekTime !== null && state.videoType === 'youtube') {
                        document.getElementById('videoUrl').value = state.videoUrl;
                        currentVideoUrl = state.videoUrl;
                        currentVideoType = state.videoType || getVideoType(state.videoUrl);
                        document.getElementById('seekTime').value = state.seekTime;
                        
                        // إعادة تحميل الفيديو مع الوقت المحدد (لـ YouTube)
                        const seekUrl = currentVideoUrl + (currentVideoUrl.includes('?') ? '&' : '?') + 'start=' + state.seekTime;
                        createVideoEmbed(seekUrl);
                    }
                    break;
            }
        }
        
        // دالة لعرض الخطأ
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            // إخفاء الرسالة بعد 5 ثوان
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
        
        // عند تحميل الصفحة
        window.onload = function() {
            // إنشاء معرف فريد للمستخدم
            window.userId = Math.random().toString(36).substring(7);
            
            // بدء الاستماع للتغييرات في Firebase
            listenToFirebaseChanges();
            
            // تحميل حالة الفيديو الحالية من Firebase
            if (database) {
                database.ref('videoState').once('value')
                    .then((snapshot) => {
                        const state = snapshot.val();
                        if (state && state.videoUrl) {
                            document.getElementById('videoUrl').value = state.videoUrl;
                            currentVideoUrl = state.videoUrl;
                            currentVideoType = state.videoType || getVideoType(state.videoUrl);
                            createVideoEmbed(state.videoUrl);
                        }
                    })
                    .catch((error) => {
                        console.error('خطأ في تحميل حالة الفيديو:', error);
                        showError('حدث خطأ في تحميل حالة الفيديو. تأكد من اتصال الإنترنت.');
                    });
            }
        };
        
        // السماح بإدخال الرابط بالضغط على Enter
        document.getElementById('videoUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadVideo();
            }
        });
    </script>
</body>
</html>
